patterns:
    COMPILER:
        default-values:
            - g++
            - clang++
        short-option: c
        long-option: compiler
    MODE:
        default-values:
            - debug
            - release
        short-option: m
        long-option: mode
    TARGET:
        default-values:
            - ""
        short-option: t
        long-option: target
    RUNTARGET:
        default-values:
            - unittest
            - integration
        short-option: r
        long-option: run-target
    MODULE:
        default-values:
            - log
            - config
            - yaml
            - core
            - plugins
            - commander
        short-option: e
        long-option: module
    COMPONENT:
        default-values:
            - ""
        short-option: f
        long-option: component
    ANALYZE:
        default-values:
            - cppcheck
            - clang-static-analyzer
            - valgrind
            - pmd
            - lcov
            - clang-tidy
        short-option: a
        long-option: analyze
    DOCSTYPE:
        default-values:
            - html
            - man
        short-option: o
        long-option: docs-type
    SYSROOT:
        default-values:
            - "/"
        short-option: y
        long-option: sysroot
    SOURCE_TYPE:
        default-values:
            - src
            - test
        long-option: source-type

commands:
    setup: Setup the repository for building
    init: Initialize the build infrastructure
    init-build: Initialize the build infrastructure and switches off everything that has nothing to do with building the exec-helper binaries themselves
    build: Build-only + install
    build-only: Build only
    install: Install only
    clean: Clean build
    distclean: Distclean build
    rebuild: Clean + build
    analyze: Run the specified analysis tool(s)
    run-test: unittest + integration
    unittest: Run the specified unittests
    integration: Run the specified integration tests
    coverage: Run the coverage analysis tools using a specific setup (for convenience)
    memory-check: Run the memory check analysis tool for a specific setup (for convenience)
    undefined-behaviour: Check for undefined behaviour using UBSan
    docs: Build + install the documentation
    changelog: Build the changelog
    create-toolchain-file: Create the associated toolchain file

setup:
    - command-line-command

init:
    - create-toolchain-file
    - command-line-command

init-build:
    - create-toolchain-file
    - command-line-command

build:
    - build-only
    - install

build-only:
    - make

install:
    - command-line-command

clean:
    - make

distclean:
    - command-line-command

rebuild:
    - clean
    - build

analyze:
    - selector

run-test:
    - selector

unittest:
    - command-line-command

integration:
    - command-line-command

coverage:
    - command-line-command

memory-check:
    - command-line-command

docs:
    - make
    - command-line-command

selector:
    analyze:
        pattern: ANALYZE
    run-test:
        pattern: RUNTARGET

undefined-behaviour:
    - command-line-command

changelog:
    - make
    - command-line-command

create-toolchain-file:
    - command-line-command

make:
    patterns:
        - COMPILER
        - MODE
    build-dir: build/{COMPILER}/{MODE}/build
    single-threaded: no
    clean:
        command-line:
            - clean
    docs:
        patterns:
            - COMPILER
            - MODE
            - DOCSTYPE
        command-line:
            - docs-{DOCSTYPE}
    changelog:
        patterns:
            - COMPILER
            - MODE
        command-line:
            - changelog

cppcheck:
    patterns:
        - SOURCE_TYPE
        - MODULE
        - TARGET
    src-dir: "{SOURCE_TYPE}/{MODULE}"
    target-path: "{TARGET}"
    command-line:
        - --std=c++11
        - --error-exitcode=1
    enable-checks:
        - all

clang-static-analyzer:
    build-command:
        - init-build
        - build
    clean-command: clean

command-line-command:
    setup:
        patterns:
            - COMPILER
            - MODE
        command-line: [ ln, -fs, "build/{COMPILER}/{MODE}/build/compile_commands.json"]
    init:
        patterns:
            - COMPILER
            - MODE
        command-line:
            [ cmake, -H., "-Bbuild/{COMPILER}/{MODE}/build", "-DCMAKE_CXX_COMPILER={COMPILER}", "-DCMAKE_INSTALL_PREFIX=build/{COMPILER}/{MODE}/install", -DCMAKE_EXPORT_COMPILE_COMMANDS=ON, "-DCMAKE_BUILD_TYPE={MODE}", -DUSE_SYSTEM_CATCH=OFF, -DBUILD_HTML_DOCUMENTATION=ON, -DBUILD_MAN_DOCUMENTATION=ON, "-DCMAKE_TOOLCHAIN_FILE=build/{COMPILER}/{MODE}/toolchain.cmake", -DTERMINATE_ON_ASSERT_FAILURE=ON]
    init-build:
        patterns:
            - COMPILER
            - MODE
        command-line: [ cmake, -H., "-Bbuild/{COMPILER}/{MODE}/build", "-DCMAKE_CXX_COMPILER={COMPILER}", "-DCMAKE_INSTALL_PREFIX=build/{COMPILER}/{MODE}/install", -DCMAKE_EXPORT_COMPILE_COMMANDS=ON, "-DCMAKE_BUILD_TYPE={MODE}", -DUSE_SYSTEM_CATCH=OFF, -DBUILD_HTML_DOCUMENTATION=OFF, -DBUILD_MAN_DOCUMENTATION=OFF, "-DCMAKE_TOOLCHAIN_FILE=build/{COMPILER}/{MODE}/toolchain.cmake", -DTERMINATE_ON_ASSERT_FAILURE=ON]
    create-toolchain-file:
        patterns:
            - COMPILER
            - SYSROOT
            - MODE
        command-line:
            - remove-toolchain-tmp: [ rm, -f, "build/{COMPILER}/{MODE}/toolchain.cmake"]
            - create-build-dir: [ mkdir, -p, "build/{COMPILER}/{MODE}"]
            - create-toolchain-tmp: [ cp, toolchain.cmake.in, "build/{COMPILER}/{MODE}/toolchain.cmake"]
            - replace-CPP-compiler: [ sed, -i, 's%@CXX_COMPILER@%{COMPILER}%g', "build/{COMPILER}/{MODE}/toolchain.cmake"]
            - replace-sysroot: [ sed, -i, 's%@SYSROOT@%{SYSROOT}%g', "build/{COMPILER}/{MODE}/toolchain.cmake"]
    distclean:
        patterns:
            - COMPILER
            - MODE
        command-line: [ rm, -rf, "build/{COMPILER}/{MODE}"]
    install:
        patterns:
            - COMPILER
            - MODE
            - COMPONENT
        command-line: [ cmake, "-DCOMPONENT={COMPONENT}", -P, "build/{COMPILER}/{MODE}/build/cmake_install.cmake"]
    unittest:
        patterns:
            - COMPILER
            - MODE
            - MODULE
        command-line: build/{COMPILER}/{MODE}/install/bin/test/unittest/exec-helper-{MODULE}-unittest
    integration:
        patterns:
            - COMPILER
            - MODE
        command-line: build/{COMPILER}/{MODE}/install/bin/test/integration/exec-helper-integration-test
    coverage:
        environment:
            CXXFLAGS: --coverage -fprofile-arcs -ftest-coverage
            LDFLAGS: -fprofile-arcs -ftest-coverage
        command-line: [ exec-helper, init-build, build, analyze, --analyze, lcov, --compiler, g++, --mode, coverage, --run-target, unittest]
    undefined-behaviour:
        environment:
            CXXFLAGS: -g -fsanitize=undefined -fno-omit-frame-pointer -fno-sanitize-recover=undefined -fsanitize-blacklist="$(pwd)/suppressions/ubsan.blacklist"
            LDFLAGS: -g -fsanitize=undefined -fno-omit-frame-pointer -fno-sanitize-recover=undefined -fsanitize-blacklist="$(pwd)/suppressions/ubsan.blacklist"
            UBSAN_OPTIONS: print_stacktrace=1
        command-line: [ exec-helper, init-build, build, run-test, --compiler, clang++, --mode, undefined-behaviour, --run-target, unittest]
    memory-check:
        command-line: [ exec-helper, analyze, --analyze, valgrind, --run-target, unittest, --compiler, g++, --mode, debug]
    docs:
        patterns:
            - COMPILER
            - MODE
            - DOCSTYPE
        command-line: [ cmake, "-DCOMPONENT=docs-{DOCSTYPE}", -P, "build/{COMPILER}/{MODE}/build/cmake_install.cmake"]

    changelog:
        patterns:
            - COMPILER
            - MODE
        command-line: [ cmake, "-DCOMPONENT=changelog", -P, "build/{COMPILER}/{MODE}/build/cmake_install.cmake"]

valgrind:
    run-command: run-test
    analyze:
        tool: memcheck
        command-line:
           - --leak-check=full 

pmd:
    patterns:
        - SOURCE_TYPE
        - MODULE
    exec: 3rdparty/pmd/pmd-bin-5.8.1/bin/run.sh
    tool:
        - cpd
    language: cpp
    files: 
        - "{SOURCE_TYPE}/{MODULE}"
    minimum-tokens: 100
    command-line:
        - " "

lcov:
    run-command: run-test
    base-directory: .
    directory: .
    zero-counters: yes
    excludes:
        - /usr*
        - "*/3rdparty/*"
        - "*/test/*"
    gen-html: yes
    gen-html-output: test_coverage
    gen-html-command-line:
        - --num-spaces
        - 4

clang-tidy:
    analyze:
        patterns:
            - SOURCE_TYPE
            - MODULE
        sources:
            - "{SOURCE_TYPE}/{MODULE}/src/*.cpp"
